<UserControl x:Class="InsightMediaGenerator.Views.BatchImageView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="800"
             TextElement.Foreground="{StaticResource TextPrimaryBrush}"
             AllowDrop="True" Drop="OnFileDrop">
    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="20">
        <StackPanel>
            <!-- Status -->
            <Border Background="{Binding SdConnected, Converter={StaticResource BoolToColorConverter}}"
                    CornerRadius="4" Padding="8" Margin="0,0,0,15" HorizontalAlignment="Left">
                <TextBlock Text="{Binding StatusMessage}" Foreground="White" FontWeight="SemiBold"/>
            </Border>

            <!-- JSON File Upload Area -->
            <Border BorderBrush="{StaticResource BorderDefaultBrush}" BorderThickness="2" CornerRadius="8"
                    Background="{StaticResource BgElevatedBrush}" Padding="20" Margin="0,0,0,15">
                <StackPanel HorizontalAlignment="Center">
                    <TextBlock Text="Drop JSON file here or click to select"
                               HorizontalAlignment="Center" Margin="0,0,0,10"/>
                    <Button Content="Select JSON File" Click="OnSelectJsonFile"
                            Width="150" Height="35"/>
                </StackPanel>
            </Border>

            <!-- JSON File List -->
            <Expander Header="Registered JSON Files" IsExpanded="True" Margin="0,0,0,15">
                <StackPanel>
                    <TextBox Text="{Binding JsonSearchText, UpdateSourceTrigger=PropertyChanged}"
                             Margin="0,10,0,10"/>
                    <ListBox ItemsSource="{Binding JsonFiles}"
                             SelectedItem="{Binding SelectedJsonFile}"
                             Height="150">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel>
                                        <TextBlock Text="{Binding FileName}" FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding Comment}" Foreground="{StaticResource TextTertiaryBrush}" FontSize="11"/>
                                    </StackPanel>
                                    <Button Grid.Column="1" Content="X" Width="25" Height="25"
                                            Command="{Binding DataContext.DeleteJsonFileCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                            CommandParameter="{Binding}"
                                            VerticalAlignment="Center"/>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </StackPanel>
            </Expander>

            <!-- Character Selection -->
            <TextBlock Text="Characters" FontWeight="SemiBold" Margin="0,0,0,5"/>
            <CheckBox Content="Select All" IsChecked="{Binding SelectAllCharacters}" Margin="0,0,0,5"/>
            <Border BorderBrush="{StaticResource BorderDefaultBrush}" BorderThickness="1" CornerRadius="4"
                    MaxHeight="200" Margin="0,0,0,15">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding Characters}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <CheckBox Content="{Binding Name}" IsChecked="{Binding IsSelected}"
                                          Margin="5,3"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Border>

            <!-- Generation Settings -->
            <Expander Header="Generation Settings" IsExpanded="True" Margin="0,0,0,15">
                <StackPanel Margin="0,10,0,0">
                    <!-- Model Selection -->
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Margin="0,0,10,0">
                            <TextBlock Text="Model" FontWeight="SemiBold" Margin="0,0,0,5"/>
                            <ComboBox ItemsSource="{Binding Models}"
                                      SelectedItem="{Binding SelectedModel}"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1">
                            <TextBlock Text="LoRA" FontWeight="SemiBold" Margin="0,0,0,5"/>
                            <ComboBox ItemsSource="{Binding Loras}"
                                      SelectedItem="{Binding SelectedLora}"/>
                        </StackPanel>
                    </Grid>

                    <!-- LoRA Weight -->
                    <TextBlock Text="LoRA Weight" FontWeight="SemiBold" Margin="0,0,0,5"/>
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="60"/>
                        </Grid.ColumnDefinitions>
                        <Slider Value="{Binding LoraWeight}" Minimum="0" Maximum="1.5"
                                TickFrequency="0.1" IsSnapToTickEnabled="True" VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1" Text="{Binding LoraWeight, StringFormat=F1}"
                                 TextAlignment="Center" Margin="10,0,0,0"/>
                    </Grid>

                    <!-- Resolution and Sampler -->
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Margin="0,0,10,0">
                            <TextBlock Text="Resolution" FontWeight="SemiBold" Margin="0,0,0,5"/>
                            <ComboBox ItemsSource="{Binding Resolutions}"
                                      SelectedItem="{Binding SelectedResolution}"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1">
                            <TextBlock Text="Sampler" FontWeight="SemiBold" Margin="0,0,0,5"/>
                            <ComboBox ItemsSource="{Binding Samplers}"
                                      SelectedItem="{Binding SelectedSampler}"/>
                        </StackPanel>
                    </Grid>

                    <!-- Steps -->
                    <TextBlock Text="Steps" FontWeight="SemiBold" Margin="0,0,0,5"/>
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="60"/>
                        </Grid.ColumnDefinitions>
                        <Slider Value="{Binding Steps}" Minimum="10" Maximum="100"
                                TickFrequency="1" IsSnapToTickEnabled="True" VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1" Text="{Binding Steps}"
                                 TextAlignment="Center" Margin="10,0,0,0"/>
                    </Grid>

                    <!-- CFG Scale -->
                    <TextBlock Text="CFG Scale" FontWeight="SemiBold" Margin="0,0,0,5"/>
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="60"/>
                        </Grid.ColumnDefinitions>
                        <Slider Value="{Binding CfgScale}" Minimum="1" Maximum="20"
                                TickFrequency="0.5" IsSnapToTickEnabled="True" VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1" Text="{Binding CfgScale, StringFormat=F1}"
                                 TextAlignment="Center" Margin="10,0,0,0"/>
                    </Grid>

                    <!-- Batch Count -->
                    <TextBlock Text="Images per Character" FontWeight="SemiBold" Margin="0,0,0,5"/>
                    <ComboBox ItemsSource="{Binding BatchCounts}"
                              SelectedItem="{Binding BatchCount}" Width="100" HorizontalAlignment="Left"/>
                </StackPanel>
            </Expander>

            <!-- Progress -->
            <TextBlock Text="{Binding ProgressMessage}" Margin="0,0,0,5"
                       Visibility="{Binding ProgressMessage, Converter={StaticResource StringToVisibilityConverter}}"/>
            <ProgressBar Value="{Binding Progress}" Height="20" Margin="0,0,0,15"
                         Visibility="{Binding IsGenerating, Converter={StaticResource BoolToVisibilityConverter}}"/>

            <!-- Buttons -->
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                <Button Content="Generate Batch" Command="{Binding GenerateBatchCommand}"
                        Width="150" Height="40" Margin="0,0,10,0"
                        Style="{StaticResource PrimaryButtonStyle}"/>
                <Button Content="Cancel" Command="{Binding CancelGenerationCommand}"
                        Width="100" Height="40"
                        IsEnabled="{Binding IsGenerating}"/>
            </StackPanel>
        </StackPanel>
    </ScrollViewer>
</UserControl>
